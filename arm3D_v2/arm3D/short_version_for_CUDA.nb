(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     47819,       1410]
NotebookOptionsPosition[     45205,       1332]
NotebookOutlinePosition[     45591,       1349]
CellTagsIndexPosition[     45548,       1346]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["Note", "Subsection",
 CellChangeTimes->{{3.6957809400599556`*^9, 3.695780988096385*^9}, {
  3.695782026068845*^9, 3.6957820269283285`*^9}}],

Cell["\<\
\tFunctions Used :\t\t\tCUDA Functions Used:
\t - ImageResize\t\t\t - 
\t - ImageDimensions\t\t\t - 
\t - ImageData\t\t\t\t - 
\t - ImageSubtract\t\t\t - CUDAImageSubtract
\t - ImageAdd\t\t\t\t - CUDAImageAdd
\t - ImageMultiply\t\t\t - 
\t - ImageCrop\t\t\t\t - 
\t - ColorQuantize\t\t\t - 
\t - ColorSeparate\t\t\t - 
\t - ColorNegate\t\t\t - CUDAColorNegate
\t - Colorize\t\t\t\t - 
\t - Closing\t\t\t\t - CUDAClosing
\t - Binarize\t\t\t\t - 
\t - DeleteSmallComponents\t\t - 
\t - DistanceTransform\t\t - 
\t - Dilation\t\t\t\t - CUDADilation
\t - Erosion\t\t\t\t - CUDAErosion
\t - MorphologicalComponents\t - 
\t - Map\t\t\t\t\t - 
Time:\t\t\t\t(4.799 s)\t\t\t(4.875 s)\
\>", "Text",
 CellChangeTimes->{{3.6957809917529907`*^9, 3.695781118923383*^9}, {
   3.6957811785547953`*^9, 3.695781205745223*^9}, {3.6957812367480855`*^9, 
   3.6957812651889133`*^9}, {3.6957813027556553`*^9, 3.695781464335536*^9}, {
   3.695781520107156*^9, 3.695781522372645*^9}, {3.69578165221131*^9, 
   3.695781794554352*^9}, {3.6957818542517123`*^9, 3.6957819602323236`*^9}, 
   3.695782272236845*^9}],

Cell["\<\
Resized scale = 3
Skin thickness = 1
Blurring distance = 5
Initial Image Dimensions = { 114 , 134 , 54 }
Sample depth :\tBefore resizing = 8
\t\t\tAfter resizing = 1\
\>", "Text",
 CellChangeTimes->{{3.695782248545865*^9, 3.6957822572811737`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Needs", "[", "\"\<CUDALink`\>\"", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetDirectory", "[", 
   RowBox[{"FileNameJoin", "[", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"NotebookDirectory", "[", "]"}], ",", "\"\<Color_arm_1\>\""}], 
     "}"}], "]"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"files", "=", 
   RowBox[{"FileNames", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"slices", "=", 
   RowBox[{"Import", "/@", "files"}]}], ";"}]}], "Input"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Way 1: NOT Using CUDA", "Subsection",
 CellChangeTimes->{{3.6944033498436546`*^9, 3.6944033806313663`*^9}, {
   3.694531700994049*^9, 3.694531703759405*^9}, {3.695776843322293*^9, 
   3.695776848151064*^9}, 3.695780929058749*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"testTime", "=", 
   RowBox[{"TimeUsed", "[", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.695778309097842*^9, 3.695778320630663*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"scale", "=", "3"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"test", "=", 
   RowBox[{"slices", "[", 
    RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"testQ", "=", 
  RowBox[{"ColorQuantize", "[", 
   RowBox[{"test", ",", "4"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.6932643494744473`*^9, 3.693264378576474*^9}, {
   3.6932646580968857`*^9, 3.69326466748851*^9}, {3.693264715142432*^9, 
   3.6932647178306985`*^9}, {3.693265351484208*^9, 3.6932653518748784`*^9}, {
   3.6957452014864535`*^9, 3.6957452599264655`*^9}, {3.695749140317457*^9, 
   3.695749149985461*^9}, {3.6957767456757007`*^9, 3.6957767476915464`*^9}, {
   3.6957768857335777`*^9, 3.695776944005411*^9}, 3.6957776063313046`*^9, {
   3.6957788724562483`*^9, 3.695778874565852*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"{", 
   RowBox[{"testSep1", ",", "testSep2", ",", "testSep3"}], "}"}], "=", 
  RowBox[{"ColorSeparate", "[", 
   RowBox[{"testQ", ",", "\"\<RGB\>\""}], "]"}]}]], "Input",
 CellChangeTimes->{{3.6957452838145046`*^9, 3.695745295490471*^9}, {
   3.695745335783868*^9, 3.695745358343871*^9}, {3.6957489569447947`*^9, 
   3.6957489751407995`*^9}, 3.6957491327815046`*^9, {3.6957769750395937`*^9, 
   3.6957769829627824`*^9}, 3.6957776054244843`*^9, 3.695778618651581*^9, 
   3.6957788805977526`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"scale", "=", "3"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testLayer1", "=", 
   RowBox[{"ImageResize", "[", 
    RowBox[{
     RowBox[{"Binarize", "[", "testSep1", "]"}], ",", 
     RowBox[{"scale", "*", 
      RowBox[{"ImageDimensions", "[", "testSep1", "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testLayer2", "=", 
   RowBox[{"ImageResize", "[", 
    RowBox[{
     RowBox[{"Binarize", "[", "testSep2", "]"}], ",", 
     RowBox[{"scale", "*", 
      RowBox[{"ImageDimensions", "[", "testSep2", "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testLayer3", "=", 
   RowBox[{"ImageResize", "[", 
    RowBox[{
     RowBox[{"Binarize", "[", "testSep3", "]"}], ",", 
     RowBox[{"scale", "*", 
      RowBox[{"ImageDimensions", "[", "testSep3", "]"}]}]}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.695777028467412*^9, 3.695777054595021*^9}, {
  3.695778884488328*^9, 3.695778887364108*^9}}],

Cell[BoxData[
 RowBox[{"testAir", "=", 
  RowBox[{"DeleteSmallComponents", "[", 
   RowBox[{"ColorNegate", "[", "testLayer1", "]"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.695777073675197*^9, 3.695777082457887*^9}, 
   3.6957776078625264`*^9, 3.6957788963181915`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"MorphologicalComponents", "[", "testLayer3", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testBone", "=", 
  RowBox[{"Colorize", "[", 
   RowBox[{"%", ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"2", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"1.", ",", "1.", ",", "1."}], "]"}]}], ",", 
       RowBox[{"_", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "0."}], "]"}]}]}], "}"}]}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957771144117727`*^9, 3.6957771418991604`*^9}, 
   3.6957776105192347`*^9, 3.6957789002400465`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ImageSubtract", "[", 
   RowBox[{"testLayer1", ",", "testBone"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MorphologicalComponents", "[", "%", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testMarrow", "=", 
  RowBox[{"Colorize", "[", 
   RowBox[{"%", ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"2", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"1.", ",", "1.", ",", "1."}], "]"}]}], ",", 
       RowBox[{"_", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "0."}], "]"}]}]}], "}"}]}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.695777202306975*^9, 3.6957772143708344`*^9}, 
   3.6957776146756735`*^9, 3.695778904490506*^9}],

Cell[BoxData[
 RowBox[{"testBoneAndMarrow", "=", 
  RowBox[{"ImageAdd", "[", 
   RowBox[{"testBone", ",", "testMarrow"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.69577721877711*^9, 3.6957772299818845`*^9}, 
   3.695777613644567*^9, 3.695778907897564*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"skinThickness", "=", "1"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"testFalseSkin", "=", 
  RowBox[{"ImageSubtract", "[", 
   RowBox[{
    RowBox[{"Dilation", "[", 
     RowBox[{"testAir", ",", "skinThickness"}], "]"}], ",", "testAir"}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957772571965857`*^9, 3.6957772666507363`*^9}, 
   3.6957789126324463`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ImageCrop", "[", 
   RowBox[{"testFalseSkin", ",", 
    RowBox[{"scale", "*", 
     RowBox[{"{", 
      RowBox[{"69", ",", "27"}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"-", "1"}], ",", "1"}], "}"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ImageCrop", "[", 
   RowBox[{"%", ",", 
    RowBox[{"scale", "*", 
     RowBox[{"{", 
      RowBox[{"114", ",", "134"}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{"1", ",", 
      RowBox[{"-", "1"}]}], "}"}], ",", 
    RowBox[{"Padding", "\[Rule]", "Black"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ImageSubtract", "[", 
   RowBox[{"testFalseSkin", ",", "%"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MorphologicalComponents", "[", "%", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testCroppedSkin", "=", 
   RowBox[{"Colorize", "[", 
    RowBox[{"%", ",", 
     RowBox[{"ColorRules", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"1", "\[Rule]", 
         RowBox[{"RGBColor", "[", 
          RowBox[{"0.", ",", "1.", ",", "0."}], "]"}]}], ",", 
        RowBox[{"_", "\[Rule]", 
         RowBox[{"RGBColor", "[", 
          RowBox[{"0.", ",", "0.", ",", "0."}], "]"}]}]}], "}"}]}]}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{"testSkin", "=", 
  RowBox[{"Closing", "[", 
   RowBox[{"testCroppedSkin", ",", "1"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957772916685762`*^9, 3.6957773454869003`*^9}, 
   3.695777623504583*^9, 3.695778916695386*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ImageSubtract", "[", 
   RowBox[{"testLayer1", ",", "testLayer2", ",", 
    RowBox[{"Binarize", "[", "testBoneAndMarrow", "]"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MorphologicalComponents", "[", "%", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Colorize", "[", 
   RowBox[{"%", ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"1", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"1.", ",", "0.", ",", "0."}], "]"}]}], ",", 
       RowBox[{"_", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "0."}], "]"}]}]}], "}"}]}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Dilation", "[", 
   RowBox[{"%", ",", "10"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"testMuscle", "=", 
  RowBox[{"Erosion", "[", 
   RowBox[{"%", ",", "10"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957773718458276`*^9, 3.6957773889571066`*^9}, 
   3.695777626411592*^9, 3.695778920648934*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ImageSubtract", "[", 
   RowBox[{"testLayer1", ",", 
    RowBox[{"Binarize", "[", "testMuscle", "]"}], ",", 
    RowBox[{"Binarize", "[", "testSkin", "]"}], ",", 
    RowBox[{"Binarize", "[", "testBoneAndMarrow", "]"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testWaste", "=", 
   RowBox[{"MorphologicalComponents", "[", "%", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testFat", "=", 
  RowBox[{"Colorize", "[", 
   RowBox[{"testWaste", ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"1", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "1."}], "]"}]}], ",", 
       RowBox[{"_", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "0."}], "]"}]}]}], "}"}]}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957774449687195`*^9, 3.6957774710973654`*^9}, {
   3.695777514945797*^9, 3.695777515977194*^9}, 3.6957776283177323`*^9, 
   3.6957789251489773`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"testWasteMuscle", "=", 
   RowBox[{"Colorize", "[", 
    RowBox[{"testWaste", ",", 
     RowBox[{"ColorRules", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"2", "\[Rule]", 
         RowBox[{"RGBColor", "[", 
          RowBox[{"1.", ",", "0.", ",", "0."}], "]"}]}], ",", 
        RowBox[{"3", "\[Rule]", 
         RowBox[{"RGBColor", "[", 
          RowBox[{"1.", ",", "0.", ",", "0."}], "]"}]}], ",", 
        RowBox[{"_", "\[Rule]", 
         RowBox[{"RGBColor", "[", 
          RowBox[{"0.", ",", "0.", ",", "0."}], "]"}]}]}], "}"}]}]}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{"testMuscle", "=", 
  RowBox[{"ImageAdd", "[", 
   RowBox[{"testMuscle", ",", "testWasteMuscle"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957775677497225`*^9, 3.6957775911429057`*^9}, 
   3.695777630912073*^9, 3.695778928915449*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ImageSubtract", "[", 
   RowBox[{"testLayer1", ",", 
    RowBox[{"Binarize", "[", "testSkin", "]"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MorphologicalComponents", "[", "%", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testAllExceptSkin", "=", 
  RowBox[{"Colorize", "[", 
   RowBox[{"%", ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"0", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "0."}], "]"}]}], ",", 
       RowBox[{"_", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "1."}], "]"}]}]}], "}"}]}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.695777657498259*^9, 3.695777666701995*^9}, 
   3.695777742524985*^9, 3.695778933134183*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ImageCrop", "[", 
   RowBox[{
    RowBox[{"ImageCrop", "[", 
     RowBox[{"testAllExceptSkin", ",", 
      RowBox[{"scale", "*", 
       RowBox[{"{", 
        RowBox[{"69", ",", "27"}], "}"}]}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", "1"}], ",", "1"}], "}"}]}], "]"}], ",", 
    RowBox[{"scale", "*", 
     RowBox[{"{", 
      RowBox[{"51", ",", "17"}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{"1", ",", 
      RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Colorize", "[", 
   RowBox[{
    RowBox[{"MorphologicalComponents", "[", "%", "]"}], ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"_", "\[Rule]", 
       RowBox[{"RGBColor", "[", 
        RowBox[{"0.", ",", "0.", ",", "1."}], "]"}]}], "}"}]}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ImageCrop", "[", 
   RowBox[{
    RowBox[{"ImageCrop", "[", 
     RowBox[{"%", ",", 
      RowBox[{"scale", "*", 
       RowBox[{"{", 
        RowBox[{"69", ",", "27"}], "}"}]}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
      RowBox[{"Padding", "\[Rule]", "Black"}]}], "]"}], ",", 
    RowBox[{"scale", "*", 
     RowBox[{"{", 
      RowBox[{"114", ",", "134"}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{"1", ",", 
      RowBox[{"-", "1"}]}], "}"}], ",", 
    RowBox[{"Padding", "\[Rule]", "Black"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testAllExceptSkin", "=", 
  RowBox[{"ImageAdd", "[", 
   RowBox[{"testAllExceptSkin", ",", "%"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957776887375107`*^9, 3.6957777200693655`*^9}, 
   3.695777756666664*^9, 3.6957789363068714`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"signedDistance", "[", "i_", "]"}], ":=", 
   RowBox[{
    RowBox[{"ImageData", "[", 
     RowBox[{"DistanceTransform", "[", 
      RowBox[{"ColorNegate", "[", "i", "]"}], "]"}], "]"}], "-", 
    RowBox[{"ImageData", "[", 
     RowBox[{"DistanceTransform", "[", "i", "]"}], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"testSkinDist", ",", "testFatDist"}], "}"}], "=", 
   RowBox[{"signedDistance", " ", "/@", " ", 
    RowBox[{"{", 
     RowBox[{"testSkin", ",", "testAllExceptSkin"}], "}"}]}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.6957777660895596`*^9, 3.695777776216112*^9}, {
  3.6957789424945574`*^9, 3.6957789471669426`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"blendDistance", "=", "5"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"weight", "[", 
    RowBox[{"dist_", ",", "blendDist_"}], "]"}], ":=", 
   RowBox[{"Piecewise", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"1.", ",", 
         RowBox[{"dist", "<", " ", 
          RowBox[{"-", "blendDist"}]}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"0.", ",", " ", 
         RowBox[{"dist", " ", ">", " ", "blendDist"}]}], "}"}]}], "}"}], ",", 
     RowBox[{"0.5", "*", 
      RowBox[{"(", 
       RowBox[{"1", "-", 
        RowBox[{"dist", "/", "blendDist"}]}], ")"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"weight", ",", " ", "Listable"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testSkinWeights", " ", "=", " ", 
   RowBox[{"weight", "[", 
    RowBox[{"testSkinDist", ",", " ", "blendDistance"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testFatWeights", " ", "=", " ", 
   RowBox[{"weight", "[", 
    RowBox[{"testFatDist", ",", " ", "blendDistance"}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.695777810142744*^9, 3.6957778265825276`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"skinProp", "=", 
   RowBox[{"{", 
    RowBox[{"0.", ",", "1.", ",", "0."}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fatProp", "=", 
   RowBox[{"{", 
    RowBox[{"0.", ",", "0.", ",", "1."}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"weightToProp", "[", 
    RowBox[{"w_", ",", " ", "prop_"}], "]"}], " ", ":=", " ", 
   RowBox[{"w", "*", "prop"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testWeightedSkin", "=", " ", 
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"weightToProp", "[", 
       RowBox[{"#", ",", " ", "skinProp"}], "]"}], "&"}], ",", " ", 
     "testSkinWeights", ",", " ", 
     RowBox[{"{", "3", "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testWeightedFat", "=", " ", 
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"weightToProp", "[", 
       RowBox[{"#", ",", " ", "fatProp"}], "]"}], "&"}], ",", 
     "testFatWeights", ",", " ", 
     RowBox[{"{", "3", "}"}]}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.695777895024448*^9, 3.6957779186988697`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Image", "[", 
   RowBox[{"testWeightedFat", " ", "+", "testWeightedSkin"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testSkinAndFat", "=", 
   RowBox[{"ImageMultiply", "[", 
    RowBox[{"%", ",", 
     RowBox[{"ImageAdd", "[", 
      RowBox[{"testSkin", ",", "testAllExceptSkin"}], "]"}]}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.6957778454090157`*^9, 3.695777868193189*^9}, 
   3.695777927246189*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ImageCrop", "[", 
   RowBox[{
    RowBox[{"ImageCrop", "[", 
     RowBox[{"testAllExceptSkin", ",", 
      RowBox[{"scale", "*", 
       RowBox[{"{", 
        RowBox[{"69", ",", "27"}], "}"}]}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", "1"}], ",", "1"}], "}"}]}], "]"}], ",", 
    RowBox[{"scale", "*", 
     RowBox[{"{", 
      RowBox[{"51", ",", "17"}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{"1", ",", 
      RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Colorize", "[", 
   RowBox[{
    RowBox[{"MorphologicalComponents", "[", "%", "]"}], ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"_", "\[Rule]", 
       RowBox[{"RGBColor", "[", 
        RowBox[{"0.", ",", "0.", ",", "1."}], "]"}]}], "}"}]}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ImageCrop", "[", 
   RowBox[{
    RowBox[{"ImageCrop", "[", 
     RowBox[{"%", ",", 
      RowBox[{"scale", "*", 
       RowBox[{"{", 
        RowBox[{"69", ",", "27"}], "}"}]}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
      RowBox[{"Padding", "\[Rule]", "Black"}]}], "]"}], ",", 
    RowBox[{"scale", "*", 
     RowBox[{"{", 
      RowBox[{"114", ",", "134"}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{"1", ",", 
      RowBox[{"-", "1"}]}], "}"}], ",", 
    RowBox[{"Padding", "\[Rule]", "Black"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testAllExceptSkin", "=", 
  RowBox[{"ImageSubtract", "[", 
   RowBox[{"testSkinAndFat", ",", "%", ",", "%"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.695777953514638*^9, 3.6957780219086723`*^9}, {
   3.69577805288048*^9, 3.6957780968441825`*^9}, {3.695778131853183*^9, 
   3.6957781490581303`*^9}, {3.695778206513192*^9, 3.6957782125290804`*^9}, {
   3.6957786425450125`*^9, 3.6957786626873503`*^9}, 3.6957789598250227`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ImageAdd", "[", 
   RowBox[{"testBoneAndMarrow", ",", "testMuscle"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MorphologicalComponents", "[", "%", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Colorize", "[", 
   RowBox[{"%", ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"1", "\[Rule]", 
       RowBox[{"RGBColor", "[", 
        RowBox[{"0.", ",", "0.", ",", "1."}], "]"}]}], "}"}]}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testSkinAndFat", "=", 
  RowBox[{"ImageSubtract", "[", 
   RowBox[{"testAllExceptSkin", ",", "%", ",", "%"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957781766038084`*^9, 3.6957782167018747`*^9}, {
  3.6957789636843386`*^9, 3.695778971919632*^9}}],

Cell[BoxData[
 RowBox[{"testAssembly", "=", 
  RowBox[{"ImageAdd", "[", 
   RowBox[{
   "testSkinAndFat", ",", "testMuscle", ",", "testBoneAndMarrow", ",", 
    "testBoneAndMarrow"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.6957782429347973`*^9, 3.695778259171034*^9}, {
   3.69577829133027*^9, 3.695778295815597*^9}, 3.6957786692041154`*^9, 
   3.6957789806085105`*^9}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"testTime", "=", 
  RowBox[{
   RowBox[{"TimeUsed", "[", "]"}], "-", "testTime"}]}]], "Input",
 CellChangeTimes->{{3.6957783656976395`*^9, 3.6957783847750435`*^9}}],

Cell[BoxData["4.7989999999999835`"], "Output",
 CellChangeTimes->{{3.695778374961452*^9, 3.6957784123541145`*^9}, 
   3.6957786594682183`*^9, 3.695780749177978*^9}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Way 2: CUDA", "Subsection",
 CellChangeTimes->{{3.6944033498436546`*^9, 3.6944033806313663`*^9}, {
   3.694531700994049*^9, 3.694531703759405*^9}, {3.695776854886509*^9, 
   3.6957768606058745`*^9}, 3.6957809356220303`*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"testTime", "=", 
   RowBox[{"TimeUsed", "[", "]"}]}], ";"}]], "Input"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"scale", "=", "3"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"test", "=", 
   RowBox[{"slices", "[", 
    RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"testQ", "=", 
  RowBox[{"ColorQuantize", "[", 
   RowBox[{"test", ",", "4"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.695778993516144*^9, 3.6957789954694777`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"{", 
   RowBox[{"testSep1", ",", "testSep2", ",", "testSep3"}], "}"}], "=", 
  RowBox[{"ColorSeparate", "[", 
   RowBox[{"testQ", ",", "\"\<RGB\>\""}], "]"}]}]], "Input",
 CellChangeTimes->{{3.6957452838145046`*^9, 3.695745295490471*^9}, {
   3.695745335783868*^9, 3.695745358343871*^9}, {3.6957489569447947`*^9, 
   3.6957489751407995`*^9}, 3.6957491327815046`*^9, {3.6957769750395937`*^9, 
   3.6957769829627824`*^9}, 3.6957776054244843`*^9, {3.695778556053981*^9, 
   3.6957785577414165`*^9}, 3.6957786849870615`*^9, 3.695778849375952*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"scale", "=", "3"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testLayer1", "=", 
   RowBox[{"ImageResize", "[", 
    RowBox[{
     RowBox[{"Binarize", "[", "testSep1", "]"}], ",", 
     RowBox[{"scale", "*", 
      RowBox[{"ImageDimensions", "[", "testSep1", "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testLayer2", "=", 
   RowBox[{"ImageResize", "[", 
    RowBox[{
     RowBox[{"Binarize", "[", "testSep2", "]"}], ",", 
     RowBox[{"scale", "*", 
      RowBox[{"ImageDimensions", "[", "testSep2", "]"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testLayer3", "=", 
   RowBox[{"ImageResize", "[", 
    RowBox[{
     RowBox[{"Binarize", "[", "testSep3", "]"}], ",", 
     RowBox[{"scale", "*", 
      RowBox[{"ImageDimensions", "[", "testSep3", "]"}]}]}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.695777028467412*^9, 3.695777054595021*^9}, {
  3.695778565632907*^9, 3.695778595354802*^9}}],

Cell[BoxData[
 RowBox[{"testAir", "=", 
  RowBox[{"DeleteSmallComponents", "[", 
   RowBox[{
    StyleBox["CUDAColorNegate",
     FontColor->RGBColor[0, 1, 0],
     Background->GrayLevel[0]], "[", "testLayer1", "]"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.695777073675197*^9, 3.695777082457887*^9}, 
   3.6957776078625264`*^9, {3.695778705019998*^9, 3.6957787115576077`*^9}, 
   3.69577900626752*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"MorphologicalComponents", "[", "testLayer3", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testBone", "=", 
  RowBox[{"Colorize", "[", 
   RowBox[{"%", ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"2", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"1.", ",", "1.", ",", "1."}], "]"}]}], ",", 
       RowBox[{"_", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "0."}], "]"}]}]}], "}"}]}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957771144117727`*^9, 3.6957771418991604`*^9}, 
   3.6957776105192347`*^9, {3.69577881193472*^9, 3.6957788139507437`*^9}, 
   3.6957790109267635`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ImageSubtract", "[", 
   RowBox[{"testLayer1", ",", "testBone"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MorphologicalComponents", "[", "%", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testMarrow", "=", 
  RowBox[{"Colorize", "[", 
   RowBox[{"%", ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"2", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"1.", ",", "1.", ",", "1."}], "]"}]}], ",", 
       RowBox[{"_", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "0."}], "]"}]}]}], "}"}]}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.695777202306975*^9, 3.6957772143708344`*^9}, 
   3.6957776146756735`*^9, {3.6957788268423605`*^9, 3.6957788314994946`*^9}, {
   3.695779017802064*^9, 3.6957790798669252`*^9}, {3.6957791171898537`*^9, 
   3.6957791431618924`*^9}}],

Cell[BoxData[
 RowBox[{"testBoneAndMarrow", "=", 
  RowBox[{
   StyleBox["CUDAImageAdd",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"testBone", ",", "testMarrow"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.69577721877711*^9, 3.6957772299818845`*^9}, 
   3.695777613644567*^9, {3.695779066687891*^9, 3.6957790716259317`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"skinThickness", "=", "1"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"testFalseSkin", "=", 
  RowBox[{
   StyleBox["CUDAImageSubtract",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{
    RowBox[{
     StyleBox["CUDADilation",
      FontColor->RGBColor[0, 1, 0],
      Background->GrayLevel[0]], "[", 
     RowBox[{"testAir", ",", "skinThickness"}], "]"}], ",", "testAir"}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957772571965857`*^9, 3.6957772666507363`*^9}, {
  3.6957791535557985`*^9, 3.695779164026143*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ImageCrop", "[", 
   RowBox[{"testFalseSkin", ",", 
    RowBox[{"scale", "*", 
     RowBox[{"{", 
      RowBox[{"69", ",", "27"}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"-", "1"}], ",", "1"}], "}"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ImageCrop", "[", 
   RowBox[{"%", ",", 
    RowBox[{"scale", "*", 
     RowBox[{"{", 
      RowBox[{"114", ",", "134"}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{"1", ",", 
      RowBox[{"-", "1"}]}], "}"}], ",", 
    RowBox[{"Padding", "\[Rule]", "Black"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   StyleBox["CUDAImageSubtract",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"testFalseSkin", ",", "%"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MorphologicalComponents", "[", "%", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testCroppedSkin", "=", 
   RowBox[{"Colorize", "[", 
    RowBox[{"%", ",", 
     RowBox[{"ColorRules", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"1", "\[Rule]", 
         RowBox[{"RGBColor", "[", 
          RowBox[{"0.", ",", "1.", ",", "0."}], "]"}]}], ",", 
        RowBox[{"_", "\[Rule]", 
         RowBox[{"RGBColor", "[", 
          RowBox[{"0.", ",", "0.", ",", "0."}], "]"}]}]}], "}"}]}]}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{"testSkin", "=", 
  RowBox[{
   StyleBox["CUDAClosing",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"testCroppedSkin", ",", "1"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957772916685762`*^9, 3.6957773454869003`*^9}, 
   3.695777623504583*^9, {3.6957791722884507`*^9, 3.6957791892344475`*^9}, 
   3.6957804603105187`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   StyleBox["CUDAImageSubtract",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{
    RowBox[{
     StyleBox["CUDAImageSubtract",
      FontColor->RGBColor[0, 1, 0],
      Background->GrayLevel[0]], "[", 
     RowBox[{"testLayer1", ",", "testLayer2"}], "]"}], ",", 
    RowBox[{"Binarize", "[", "testBoneAndMarrow", "]"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MorphologicalComponents", "[", "%", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Colorize", "[", 
   RowBox[{"%", ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"1", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"1.", ",", "0.", ",", "0."}], "]"}]}], ",", 
       RowBox[{"_", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "0."}], "]"}]}]}], "}"}]}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   StyleBox["CUDADilation",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"%", ",", "10"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"testMuscle", "=", 
  RowBox[{
   StyleBox["CUDAErosion",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"%", ",", "10"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957773718458276`*^9, 3.6957773889571066`*^9}, 
   3.695777626411592*^9, {3.695779195463559*^9, 3.6957792955267577`*^9}, {
   3.6957804899225993`*^9, 3.6957805048647995`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   StyleBox["CUDAImageSubtract",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{
    RowBox[{
     StyleBox["CUDAImageSubtract",
      FontColor->RGBColor[0, 1, 0],
      Background->GrayLevel[0]], "[", 
     RowBox[{"testLayer1", ",", 
      RowBox[{"Binarize", "[", "testMuscle", "]"}]}], "]"}], ",", 
    RowBox[{
     StyleBox["CUDAImageSubtract",
      FontColor->RGBColor[0, 1, 0],
      Background->GrayLevel[0]], "[", 
     RowBox[{
      RowBox[{"Binarize", "[", "testSkin", "]"}], ",", 
      RowBox[{"Binarize", "[", "testBoneAndMarrow", "]"}]}], "]"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testWaste", "=", 
   RowBox[{"MorphologicalComponents", "[", "%", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testFat", "=", 
  RowBox[{"Colorize", "[", 
   RowBox[{"testWaste", ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"1", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "1."}], "]"}]}], ",", 
       RowBox[{"_", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "0."}], "]"}]}]}], "}"}]}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957774449687195`*^9, 3.6957774710973654`*^9}, {
   3.695777514945797*^9, 3.695777515977194*^9}, 3.6957776283177323`*^9, {
   3.6957793114030356`*^9, 3.695779346117009*^9}, 3.6957793921812835`*^9, {
   3.69578051819639*^9, 3.6957805360732784`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"testWasteMuscle", "=", 
   RowBox[{"Colorize", "[", 
    RowBox[{"testWaste", ",", 
     RowBox[{"ColorRules", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"2", "\[Rule]", 
         RowBox[{"RGBColor", "[", 
          RowBox[{"1.", ",", "0.", ",", "0."}], "]"}]}], ",", 
        RowBox[{"3", "\[Rule]", 
         RowBox[{"RGBColor", "[", 
          RowBox[{"1.", ",", "0.", ",", "0."}], "]"}]}], ",", 
        RowBox[{"_", "\[Rule]", 
         RowBox[{"RGBColor", "[", 
          RowBox[{"0.", ",", "0.", ",", "0."}], "]"}]}]}], "}"}]}]}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{"testMuscle", "=", 
  RowBox[{
   StyleBox["CUDAImageAdd",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"testMuscle", ",", "testWasteMuscle"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957775677497225`*^9, 3.6957775911429057`*^9}, 
   3.695777630912073*^9, {3.69577935370502*^9, 3.6957793675659*^9}, 
   3.6957794870999146`*^9, 3.695780619566949*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   StyleBox["CUDAImageSubtract",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"testLayer1", ",", 
    RowBox[{"Binarize", "[", "testSkin", "]"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MorphologicalComponents", "[", "%", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testAllExceptSkin", "=", 
  RowBox[{"Colorize", "[", 
   RowBox[{"%", ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"0", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "0."}], "]"}]}], ",", 
       RowBox[{"_", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "1."}], "]"}]}]}], "}"}]}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.695777657498259*^9, 3.695777666701995*^9}, 
   3.695777742524985*^9, {3.695779495967871*^9, 3.695779522571436*^9}, 
   3.6957805455743046`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ImageCrop", "[", 
   RowBox[{
    RowBox[{"ImageCrop", "[", 
     RowBox[{"testAllExceptSkin", ",", 
      RowBox[{"scale", "*", 
       RowBox[{"{", 
        RowBox[{"69", ",", "27"}], "}"}]}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", "1"}], ",", "1"}], "}"}]}], "]"}], ",", 
    RowBox[{"scale", "*", 
     RowBox[{"{", 
      RowBox[{"51", ",", "17"}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{"1", ",", 
      RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Colorize", "[", 
   RowBox[{
    RowBox[{"MorphologicalComponents", "[", "%", "]"}], ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"_", "\[Rule]", 
       RowBox[{"RGBColor", "[", 
        RowBox[{"0.", ",", "0.", ",", "1."}], "]"}]}], "}"}]}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ImageCrop", "[", 
   RowBox[{
    RowBox[{"ImageCrop", "[", 
     RowBox[{"%", ",", 
      RowBox[{"scale", "*", 
       RowBox[{"{", 
        RowBox[{"69", ",", "27"}], "}"}]}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
      RowBox[{"Padding", "\[Rule]", "Black"}]}], "]"}], ",", 
    RowBox[{"scale", "*", 
     RowBox[{"{", 
      RowBox[{"114", ",", "134"}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{"1", ",", 
      RowBox[{"-", "1"}]}], "}"}], ",", 
    RowBox[{"Padding", "\[Rule]", "Black"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testAllExceptSkin", "=", 
  RowBox[{
   StyleBox["CUDAImageAdd",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"testAllExceptSkin", ",", "%"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957776887375107`*^9, 3.6957777200693655`*^9}, 
   3.695777756666664*^9, {3.6957795293529468`*^9, 3.6957795392919827`*^9}, 
   3.695780624833294*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"signedDistance", "[", "i_", "]"}], ":=", 
   RowBox[{
    RowBox[{"ImageData", "[", 
     RowBox[{"DistanceTransform", "[", 
      RowBox[{"ColorNegate", "[", "i", "]"}], "]"}], "]"}], "-", 
    RowBox[{"ImageData", "[", 
     RowBox[{"DistanceTransform", "[", "i", "]"}], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"testSkinDist", ",", "testFatDist"}], "}"}], "=", 
   RowBox[{"signedDistance", " ", "/@", " ", 
    RowBox[{"{", 
     RowBox[{"testSkin", ",", "testAllExceptSkin"}], "}"}]}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.6957777660895596`*^9, 3.695777776216112*^9}, {
  3.6957795452417526`*^9, 3.695779551726388*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"blendDistance", "=", "5"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"weight", "[", 
    RowBox[{"dist_", ",", "blendDist_"}], "]"}], ":=", 
   RowBox[{"Piecewise", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"1.", ",", 
         RowBox[{"dist", "<", " ", 
          RowBox[{"-", "blendDist"}]}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"0.", ",", " ", 
         RowBox[{"dist", " ", ">", " ", "blendDist"}]}], "}"}]}], "}"}], ",", 
     RowBox[{"0.5", "*", 
      RowBox[{"(", 
       RowBox[{"1", "-", 
        RowBox[{"dist", "/", "blendDist"}]}], ")"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"weight", ",", " ", "Listable"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testSkinWeights", " ", "=", " ", 
   RowBox[{"weight", "[", 
    RowBox[{"testSkinDist", ",", " ", "blendDistance"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testFatWeights", " ", "=", " ", 
   RowBox[{"weight", "[", 
    RowBox[{"testFatDist", ",", " ", "blendDistance"}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.695777810142744*^9, 3.6957778265825276`*^9}, {
  3.6957795656708994`*^9, 3.6957795670931644`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"skinProp", "=", 
   RowBox[{"{", 
    RowBox[{"0.", ",", "1.", ",", "0."}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fatProp", "=", 
   RowBox[{"{", 
    RowBox[{"0.", ",", "0.", ",", "1."}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"weightToProp", "[", 
    RowBox[{"w_", ",", " ", "prop_"}], "]"}], " ", ":=", " ", 
   RowBox[{"w", "*", "prop"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testWeightedSkin", "=", " ", 
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"weightToProp", "[", 
       RowBox[{"#", ",", " ", "skinProp"}], "]"}], "&"}], ",", " ", 
     "testSkinWeights", ",", " ", 
     RowBox[{"{", "3", "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testWeightedFat", "=", 
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"weightToProp", "[", 
       RowBox[{"#", ",", " ", "fatProp"}], "]"}], "&"}], ",", 
     "testFatWeights", ",", " ", 
     RowBox[{"{", "3", "}"}]}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.695777895024448*^9, 3.6957779186988697`*^9}, {
  3.6957795742746687`*^9, 3.6957795949795456`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Image", "[", 
   RowBox[{"testWeightedFat", " ", "+", "testWeightedSkin"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testSkinAndFat", "=", 
  RowBox[{"ImageMultiply", "[", 
   RowBox[{"%", ",", 
    RowBox[{
     StyleBox["CUDAImageAdd",
      FontColor->RGBColor[0, 1, 0],
      Background->GrayLevel[0]], "[", 
     RowBox[{"testSkin", ",", "testAllExceptSkin"}], "]"}]}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957778454090157`*^9, 3.695777868193189*^9}, 
   3.695777927246189*^9, {3.695779602558514*^9, 3.6957796967175016`*^9}, 
   3.6957806274268875`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ImageCrop", "[", 
   RowBox[{
    RowBox[{"ImageCrop", "[", 
     RowBox[{"testAllExceptSkin", ",", 
      RowBox[{"scale", "*", 
       RowBox[{"{", 
        RowBox[{"69", ",", "27"}], "}"}]}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", "1"}], ",", "1"}], "}"}]}], "]"}], ",", 
    RowBox[{"scale", "*", 
     RowBox[{"{", 
      RowBox[{"51", ",", "17"}], "}"}]}], ",", 
    RowBox[{"{", 
     RowBox[{"1", ",", 
      RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Colorize", "[", 
   RowBox[{
    RowBox[{"MorphologicalComponents", "[", "%", "]"}], ",", 
    RowBox[{"ColorRules", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"_", "\[Rule]", 
       RowBox[{"RGBColor", "[", 
        RowBox[{"0.", ",", "0.", ",", "1."}], "]"}]}], "}"}]}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"crop", "=", 
   RowBox[{"ImageCrop", "[", 
    RowBox[{
     RowBox[{"ImageCrop", "[", 
      RowBox[{"%", ",", 
       RowBox[{"scale", "*", 
        RowBox[{"{", 
         RowBox[{"69", ",", "27"}], "}"}]}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
       RowBox[{"Padding", "\[Rule]", "Black"}]}], "]"}], ",", 
     RowBox[{"scale", "*", 
      RowBox[{"{", 
       RowBox[{"114", ",", "134"}], "}"}]}], ",", 
     RowBox[{"{", 
      RowBox[{"1", ",", 
       RowBox[{"-", "1"}]}], "}"}], ",", 
     RowBox[{"Padding", "\[Rule]", "Black"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   StyleBox["CUDAImageSubtract",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"testSkinAndFat", ",", "crop"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testAllExceptSkin", "=", 
  RowBox[{
   StyleBox["CUDAImageSubtract",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"%", ",", "crop"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.695777953514638*^9, 3.6957780219086723`*^9}, {
   3.69577805288048*^9, 3.6957780968441825`*^9}, {3.695778131853183*^9, 
   3.6957781490581303`*^9}, {3.695778206513192*^9, 3.6957782125290804`*^9}, {
   3.6957797113909144`*^9, 3.6957797432437844`*^9}, 3.6957797782475815`*^9, {
   3.695779963913898*^9, 3.6957799941741276`*^9}, {3.69578055157495*^9, 
   3.6957805564661255`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   StyleBox["CUDAImageAdd",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"testBoneAndMarrow", ",", "testMuscle"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MorphologicalComponents", "[", "%", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"WHAT", "=", 
   RowBox[{"Colorize", "[", 
    RowBox[{"%", ",", 
     RowBox[{"ColorRules", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{"1", "\[Rule]", 
        RowBox[{"RGBColor", "[", 
         RowBox[{"0.", ",", "0.", ",", "1."}], "]"}]}], "}"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   StyleBox["CUDAImageSubtract",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"testAllExceptSkin", ",", "WHAT"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testSkinAndFat", "=", 
   RowBox[{
    StyleBox["CUDAImageSubtract",
     FontColor->RGBColor[0, 1, 0],
     Background->GrayLevel[0]], "[", 
    RowBox[{"%", ",", "WHAT"}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.6957781766038084`*^9, 3.6957782167018747`*^9}, {
   3.695780002697744*^9, 3.69578003195646*^9}, {3.695780075945097*^9, 
   3.695780101417062*^9}, {3.695780561466677*^9, 3.695780568498639*^9}, 
   3.6957806324899015`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   StyleBox["CUDAImageAdd",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"testSkinAndFat", ",", "testMuscle"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   StyleBox["CUDAImageAdd",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"%", ",", "testBoneAndMarrow"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"testAssembly", "=", 
  RowBox[{
   StyleBox["CUDAImageAdd",
    FontColor->RGBColor[0, 1, 0],
    Background->GrayLevel[0]], "[", 
   RowBox[{"%", ",", "testBoneAndMarrow"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.6957782429347973`*^9, 3.695778259171034*^9}, {
  3.69577829133027*^9, 3.695778295815597*^9}, {3.6957801090580397`*^9, 
  3.6957801527818727`*^9}, {3.6957806356938415`*^9, 3.6957806378659286`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{"testTime", "=", 
   RowBox[{
    RowBox[{"TimeUsed", "[", "]"}], "-", "testTime"}]}]}]], "Input",
 CellChangeTimes->{{3.6957783656976395`*^9, 3.6957783847750435`*^9}, 
   3.6957807744604764`*^9}],

Cell[BoxData["4.8750000000000036`"], "Output",
 CellChangeTimes->{{3.695778374961452*^9, 3.6957784123541145`*^9}, 
   3.6957802219355454`*^9}]
}, Open  ]]
}, Open  ]]
},
WindowSize->{766, 772},
WindowMargins->{{Automatic, -7}, {Automatic, 0}},
Magnification:>1.25 Inherited,
FrontEndVersion->"11.0 for Microsoft Windows (64-bit) (2016\:5e749\:670821\
\:65e5)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 145, 2, 53, "Subsection"],
Cell[728, 26, 1095, 28, 533, "Text"],
Cell[1826, 56, 257, 8, 162, "Text"],
Cell[2086, 66, 550, 16, 192, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[2673, 87, 235, 3, 53, "Subsection"],
Cell[2911, 92, 171, 4, 57, "Input"],
Cell[3085, 98, 825, 16, 105, "Input"],
Cell[3913, 116, 529, 10, 57, "Input"],
Cell[4445, 128, 1004, 28, 306, "Input"],
Cell[5452, 158, 269, 5, 57, "Input"],
Cell[5724, 165, 679, 18, 171, "Input"],
Cell[6406, 185, 796, 22, 270, "Input"],
Cell[7205, 209, 255, 5, 71, "Input"],
Cell[7463, 216, 396, 10, 133, "Input"],
Cell[7862, 228, 1566, 46, 438, "Input"],
Cell[9431, 276, 1069, 29, 352, "Input"],
Cell[10503, 307, 1043, 27, 296, "Input"],
Cell[11549, 336, 883, 22, 270, "Input"],
Cell[12435, 360, 836, 23, 270, "Input"],
Cell[13274, 385, 1757, 52, 382, "Input"],
Cell[15034, 439, 736, 20, 190, "Input"],
Cell[15773, 461, 1266, 37, 280, "Input"],
Cell[17042, 500, 1149, 34, 280, "Input"],
Cell[18194, 536, 471, 13, 157, "Input"],
Cell[18668, 551, 1946, 54, 382, "Input"],
Cell[20617, 607, 793, 21, 240, "Input"],
Cell[21413, 630, 371, 8, 103, "Input"],
Cell[CellGroupData[{
Cell[21809, 642, 187, 4, 71, "Input"],
Cell[21999, 648, 164, 2, 46, "Output"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[22212, 656, 229, 3, 66, "Subsection"],
Cell[22444, 661, 105, 3, 71, "Input"],
Cell[22552, 666, 392, 10, 131, "Input"],
Cell[22947, 678, 577, 10, 71, "Input"],
Cell[23527, 690, 1004, 28, 382, "Input"],
Cell[24534, 720, 403, 9, 71, "Input"],
Cell[24940, 731, 730, 19, 213, "Input"],
Cell[25673, 752, 930, 24, 270, "Input"],
Cell[26606, 778, 363, 8, 46, "Input"],
Cell[26972, 788, 589, 16, 107, "Input"],
Cell[27564, 806, 1786, 53, 388, "Input"],
Cell[29353, 861, 1541, 44, 332, "Input"],
Cell[30897, 907, 1522, 41, 382, "Input"],
Cell[32422, 950, 1036, 26, 246, "Input"],
Cell[33461, 978, 970, 27, 218, "Input"],
Cell[34434, 1007, 1891, 56, 278, "Input"],
Cell[36328, 1065, 734, 20, 106, "Input"],
Cell[37065, 1087, 1319, 38, 222, "Input"],
Cell[38387, 1127, 1197, 35, 220, "Input"],
Cell[39587, 1164, 614, 16, 131, "Input"],
Cell[40204, 1182, 2365, 67, 251, "Input"],
Cell[42572, 1251, 1325, 38, 222, "Input"],
Cell[43900, 1291, 854, 23, 107, "Input"],
Cell[CellGroupData[{
Cell[44779, 1318, 253, 6, 102, "Input"],
Cell[45035, 1326, 142, 2, 46, "Output"]
}, Open  ]]
}, Open  ]]
}
]
*)

